!function(){"use strict";var t={autosave_every_milliseconds:3e4,linting_debounce_milliseconds:1e3,retry_init_after_milliseconds:50,view_source_debounce_milliseconds:1e3/60,schema:"/DocBook/DocBook 5.0.rng",theme:"flat"},e=doctored.$,i=e("body")[0];doctored.event.on("app:ready",function(){var t,e;for(doctored.init=doctored._init,t=0;t<doctored._to_be_initialized.length;t++)e=doctored._to_be_initialized[t],doctored.init(e.selector,e.options);delete doctored._to_be_initialized,doctored.ready=!0}),doctored._init=function(i,s){var o=e(i),a,d;if(!o)return console.log("Doctored.js: Unable to find the element selected by: "+i);s=s||{};for(d in t)s.hasOwnProperty(d)||(s[d]=t[d]);return a={doctored:1,root:o,root_selector:i,options:s,cache:{},init:function(){var t=this,i=doctored.util.this_function,s=window.localStorage.getItem("doctored-theme"),o=document.createElement("div"),a,d,r,n,l,h,c;if(this.root.innerHTML="",this.lint_soon=doctored.util.debounce(t.lint,t.options.linting_debounce_milliseconds,t),this.id=this.options.id||this.root_selector.replace(/[#-\[\]]/g,"").replace(/\s/g,"").toLowerCase(),d=window.localStorage.getItem("doctored-manifest-"+this.id),r=window.localStorage.getItem("doctored-tab-current-index-"+this.id),this.root.contentEditable=!0,this.root.className=doctored.CONSTANTS.doctored_container_class,this.root.addEventListener("input",i(this.lint_soon,this),!1),this.root.addEventListener("paste",i(this.paste,this),!1),this.root.addEventListener("mouseup",i(this.click,this),!1),this.root.addEventListener("touchend",i(this.click,this),!1),this.root.addEventListener("keyup",i(this.keyup_contentEditable,this),!1),this.root.addEventListener("keyup",doctored.util.debounce(this.keyup_contentEditable_sync_view_source,t.options.view_source_debounce_milliseconds,this),!1),this.root.addEventListener("mousemove",i(this.mousemove,this),!1),this.menu=document.createElement("menu"),this.menu.className="doctored-menu",this.dialog=document.createElement("menu"),this.dialog.className="doctored-dialog",this.dialog.addEventListener("keyup",i(this.keyup_dialog_esc,this),!1),this.dialog.innerHTML='<a href title="Close">&times;</a><h6>schema</h6><select></select><h6>root element</h6><select id="'+this.id+'_elements" title="Change element"><optgroup label="Suggested elements in this context"><option value="" disabled class="doctored-loading">Loading...</option></optgroup></select><h6>attributes</h6><div class="doctored-attributes"></div>',this.dialog.close=e("a",this.dialog)[0],this.dialog.close.addEventListener("click",i(this.close_dialog,this),!1),this.dialog.schema_chooser=e("select",this.dialog)[0],this.dialog.schema_chooser.addEventListener("change",i(this.schema_chooser_change,this),!1),this.dialog.schema_chooser_title=e("h6",this.dialog)[0],this.dialog.attributes_title=e("h6",this.dialog)[2],this.dialog.element_chooser=e("select",this.dialog)[1],this.dialog.element_chooser.addEventListener("blur",i(this.element_chooser_change,this),!1),this.dialog.element_chooser.addEventListener("mouseup",i(this.element_chooser_change,this),!1),this.dialog.root_element_title=e("h6",this.dialog)[1],this.dialog.attributes_div=e("div",this.dialog)[0],this.dialog.attributes_div.addEventListener("keyup",i(this.keyup_dialog_attributes_enter,this),!1),this.dialog.attributes_template=document.createElement("div"),this.dialog.attributes_template.innerHTML='<input class="doctored-attribute-name">=<input class="doctored-attribute-value">',this.dialog.attributes_add=this.dialog.attributes_template.cloneNode(!0),this.dialog.attributes_add.childNodes[0].addEventListener("focus",i(this.add_attribute_item_key,this),!1),this.dialog.attributes_add.childNodes[2].addEventListener("focus",i(this.add_attribute_item_value,this),!1),this.dialog.attributes_div.appendChild(this.dialog.attributes_add),this.dialog.add_siblings=document.createElement("div"),this.dialog.add_siblings.className="doctored-add-siblings",this.dialog.appendChild(this.dialog.add_siblings),this.dialog.add_sibling_above=document.createElement("a"),this.dialog.add_sibling_above.className="doctored-add-sibling-above",this.dialog.add_sibling_above.innerHTML="&#x25B2;",this.dialog.add_sibling_above.setAttribute("title","Add element before"),this.dialog.add_sibling_above.addEventListener("click",i(this.clone_element_above,this),!1),this.dialog.add_siblings.appendChild(this.dialog.add_sibling_above),this.dialog.add_sibling_below=document.createElement("a"),this.dialog.add_sibling_below.className="doctored-add-sibling-below",this.dialog.add_sibling_below.innerHTML="&#x25BC;",this.dialog.add_sibling_below.setAttribute("title","Add element after"),this.dialog.add_sibling_below.addEventListener("click",i(this.clone_element_below,this),!1),this.dialog.add_siblings.appendChild(this.dialog.add_sibling_below),this.tabs=document.createElement("ul"),this.tabs.className="doctored-tabs",this.tabs.tab_item_template=document.createElement("li"),this.tabs.tab_item_template.innerHTML='<span>Untitled.xml</span> <a href title="Delete" class="doctored-delete">&times;</a>',this.tabs.innerHTML='<li class="doctored-new-document"><a href title="New document">+</a></li>',this.tabs.addEventListener("click",doctored.util.prevent_default,!1),this.tabs.addEventListener("mousedown",i(this.tabs_drag_start,this),!1),this.tabs.addEventListener("touchstart",i(this.tabs_drag_start,this),!1),this.tabs.dragging=!1,this.tabs.new_document=e(".doctored-new-document",this.tabs)[0],this.tabs.new_document.addEventListener("click",i(this.tabs_add_tab,this),!1),this.menu.innerHTML='<a class="doctored-properties" href="" title="Document Properties">Document</a><a class="doctored-view-source" href="">View Source</a><a class="doctored-download" href="">Download</a>',o.innerHTML='<a class="doctored-hamburger-button" href title="Doctored.js Configuration">&#9776;</a>',this.hamburger_button=o.childNodes[0],this.hamburger_button.addEventListener("click",i(this.hamburger_button_click,this),!1),this.hamburger_menu=document.createElement("menu"),this.hamburger_menu.className="doctored-hamburger",this.hamburger_menu.innerHTML='<a href title="Close">&times;</a><select><option value="" disabled selected>Choose Theme</option><option>Flat</option><option>Shadow</option><option>High Contrast</option><option>Habitat</option></select>',this.hamburger_menu.theme_chooser=e("select",this.hamburger_menu)[0],this.hamburger_menu.theme_chooser.addEventListener("change",i(this.hamburger_change_theme,this),!1),this.hamburger_menu.close=e("a",this.hamburger_menu)[0],this.hamburger_menu.close.addEventListener("click",i(this.hamburger_close,this),!1),this.menu.properties_button=e(".doctored-properties",this.menu)[0],this.menu.properties_button.addEventListener("click",i(this.properties,this),!1),this.menu.download=e(".doctored-download",this.menu)[0],this.menu.download.addEventListener("click",i(this.download,this),!1),this.menu.view_source=e(".doctored-view-source",this.menu)[0],this.menu.view_source.addEventListener("click",i(this.view_source,this),!1),this.tooltip=document.createElement("samp"),this.tooltip.className="doctored-tooltip",this.tooltip.addEventListener(doctored.util.transition_end_event,i(this.hide_tooltip,this),!1),this.view_source_textarea=document.createElement("textarea"),this.view_source_textarea.classList.add("doctored-view-source-textbox"),this.view_source_textarea.addEventListener("keyup",doctored.util.debounce(this.view_source_change,this.options.view_source_debounce_milliseconds,this),!1),this.view_source_resizer=document.createElement("div"),this.view_source_resizer.classList.add("doctored-view-source-resizer"),this.view_source_resizer.addEventListener("mousedown",i(this.view_source_resizer_drag_start,this),!1),this.view_source_resizer.addEventListener("touchstart",i(this.view_source_resizer_drag_start,this),!1),this.view_source_resizer.dragging=!1,this.view_source_textarea.style.display="none",doctored.util.set_theme(s||this.options.theme,this),this.root.parentNode.insertBefore(this.hamburger_button,this.root),this.root.parentNode.insertBefore(this.tabs,this.root),this.root.parentNode.insertBefore(this.menu,this.root),this.root.parentNode.insertBefore(this.dialog,this.menu),this.root.parentNode.insertBefore(this.tooltip,this.dialog),this.root.parentNode.insertBefore(this.hamburger_menu,this.tooltip),this.root.parentNode.insertBefore(this.view_source_textarea,this.hamburger_menu),this.root.parentNode.insertBefore(this.view_source_resizer,this.view_source_textarea),this.styleSelect=document.createElement("div"),this.styleSelect.classList.add("styleSelect"),this.styleSelect.innerHTML="<ul></ul>",this.root.parentNode.insertBefore(this.styleSelect,this.root),this.styleSelect.addEventListener("click",i(this.styleSelect_click,this),!1),d){for(this.manifest=JSON.parse(d),c=0;c<this.manifest.length;c++)l=this.manifest[c],i(this.tabs_add_tab,this)(void 0,l.filename,l.uuid,!0);(!r||r>=this.manifest.length)&&(r=this.manifest.length-1),i(this.schema_chooser_init,this)(this.manifest[r].schema),this.tabs_select_tab(this.tabs.childNodes[r])}else this.manifest=[],i(this.schema_chooser_init,this)(),i(this.tabs_add_tab,this)(void 0,void 0,void 0,!1),i(this.schema.new_document,this.schema)();document.addEventListener("mousemove",i(this.drag,this),!1),document.addEventListener("touchmove",i(this.drag,this),!1),document.addEventListener("mouseup",i(this.drag_end,this),!1),document.addEventListener("touchend",i(this.drag_end,this),!1),window.addEventListener("beforeunload",i(this.beforeunload,this),!1),this.options.onload&&i(this.options.onload,this)()},lint:function(){var t=this.get_xml_string();return t===!1?this.lint_soon():(this.root.classList.remove("valid"),this.root.classList.remove("invalid"),void doctored.linters.lint(t,this.schema.schema_url,this.lint_response,a))},lint_response:function(t){var e=doctored.util.lint_response(t,this.root.childNodes.length),i,s,o=0;for(console.log(e),i=0;i<this.root.childNodes.length;i++)s=this.root.childNodes[i],s.nodeType===Node.ELEMENT_NODE&&(o+=1,e[o]?(s.setAttribute("data-error",doctored.util.format_lint_errors(e[o])),s.classList.add("has_errors"),s.classList.remove("hide_errors")):(s.setAttribute("data-error",""),s.classList.remove("has_errors"),s.classList.add("hide_errors")));t&&t.error_lines&&0===t.error_lines.length&&(void 0===t.error_summary||0===t.error_summary.length)?(this.root.classList.add("valid"),this.root.classList.remove("invalid")):(this.root.classList.add("invalid"),this.root.classList.remove("valid"))},get_xml_string:function(){return 0===this.root.childNodes.length?!1:doctored.CONSTANTS.xml_declaration+(this.schema.dtd?this.schema.dtd:"")+doctored.util.descend_building_xml([this.root])},set_xml_string:function(t){var e,i,s,o,a;s=doctored.util.convert_xml_to_doctored_html(t,this.schema.inline_elements).trim(),e=document.createElement("div"),e.innerHTML=s,i=e.childNodes[0],o=i.getAttribute("data-element"),a=i.getAttribute("data-attributes"),this.root.setAttribute("data-element",o||"ROOT-ERROR-NO-DATA-ELEMENT"),this.root.setAttribute("data-attributes",a||""),this.root.innerHTML=i.innerHTML,this.lint_soon()},beforeunload:function(){var t="doctored-manifest-"+this.id,e="doctored-file-"+this.tabs.current_tab.getAttribute("data-uuid"),i="doctored-tab-current-index-"+this.id,s=doctored.util.this_function,o=s(this.get_xml_string,this)(),a=doctored.util.get_tab_index(this.tabs.current_tab),d=this;window.localStorage.setItem(t,JSON.stringify(this.manifest)),window.localStorage.setItem(i,a),o&&window.localStorage.setItem(e,o)},tabs_click:function(t){var i=doctored.util.get_closest_by_nodeName(t.target,"li"),s,o,a,d;i.classList.contains("doctored-new-document")||(t.target.classList.contains("doctored-delete")?e("li",this.tabs).length<=2?doctored.util.alert("Can't delete your last document."):doctored.util.confirm("Are you sure you want to delete '"+e("span",i)[0].innerText+"'")&&(o=doctored.util.get_tab_index(i),d=this.manifest[o].uuid,window.localStorage.removeItem("doctored-file-"+d),this.manifest.splice(o,1),this.tabs.removeChild(i),i===this.tabs.current_tab&&this.tabs_select_tab(e("li",this.tabs)[0])):this.tabs.current_tab&&i===this.tabs.current_tab?(s=e("span",i)[0].textContent,s=doctored.util.prompt("New filename?",s),s&&(e("span",i)[0].textContent=s,i.setAttribute("title",s),this.manifest[doctored.util.get_tab_index(i)].filename=s)):this.tabs_select_tab(i))},tabs_select_tab:function(t){var e;this.tabs.current_tab&&(this.tabs.current_tab.classList.remove(doctored.CONSTANTS.current_tab_class),e=this.get_xml_string(),e&&window.localStorage.setItem("doctored-file-"+this.tabs.current_tab.getAttribute("data-uuid"),e)),this.tabs.current_tab=t,this.tabs.current_tab.classList.add(doctored.CONSTANTS.current_tab_class),e=window.localStorage.getItem("doctored-file-"+t.getAttribute("data-uuid")),e&&this.set_xml_string(e),this.schema_chooser_init(this.manifest[doctored.util.get_tab_index(this.tabs.current_tab)].schema),this.dialog.style.display="none"},tabs_add_tab:function(t,i,s,o){var a=doctored.util.this_function,d,r,n,l;void 0===this.tabs.count&&(this.tabs.count=0),this.tabs.count+=1,l=this.tabs.tab_item_template.cloneNode(!0),i?e("span",l)[0].textContent=i:(i=e("span",l)[0].textContent,s=doctored.util.get_uuid(),this.manifest.push({uuid:s,filename:i,schema:this.dialog.schema_chooser.options[this.dialog.schema_chooser.selectedIndex].value})),l.setAttribute("data-uuid",s),l.setAttribute("title",i),this.tabs.insertBefore(l,this.tabs.new_document),o||(this.tabs_select_tab(l),a(this.schema.new_document,this.schema)()),void 0===this.tabs.default_tab_width&&(n=e("span",l)[0],d=window.getComputedStyle(n),this.tabs.tab_span_default_width=parseInt(d.width,10),this.tabs.tab_default_width=l.offsetWidth,this.tabs.tab_boilerplate_width=this.tabs.tab_default_width-this.tabs.tab_span_default_width,d=window.getComputedStyle(l),this.tabs.tab_default_horizontal_margin=parseInt(d["margin-left"]||d.marginLeft,10)+parseInt(d["margin-right"]||d.marginRight,10),d=window.getComputedStyle(this.tabs.new_document),this.tabs.new_document_width_including_margins=this.tabs.new_document.offsetWidth+parseInt(d["margin-left"]||d.marginLeft,10)+parseInt(d["margin-right"]||d.marginRight,10)),r=this.tabs_resize(),r===!1&&(this.tabs.removeChild(l),this.tabs.count-=1,doctored.util.alert("Unable to fit any more tabs. Sorry!")),t&&t.preventDefault()},tabs_resize:function(){var t=this.tabs.offsetWidth-this.tabs.new_document_width_including_margins,i=t/this.tabs.count-this.tabs.tab_boilerplate_width-this.tabs.tab_default_horizontal_margin,s,o,a;if(i>this.tabs.tab_span_default_width&&(i=this.tabs.tab_span_default_width),i<doctored.CONSTANTS.minimum_tab_width)return!1;for(s=e("span",this.tabs),a=0;a<s.length;a++)o=s[a],o.style.width=i+"px"},schema_chooser_init:function(t){var e=doctored.util.this_function,i=t||this.options.schema,s,o,a,d;for(this.dialog.schema_chooser.innerHTML='<option value="" disabled>Choose Schema</option>'+doctored.util.process_schema_groups(doctored.schemas.list),d=0;d<this.dialog.schema_chooser.options.length;d++)a=this.dialog.schema_chooser.options[d],a.value&&!a.disabled&&(void 0===o&&(o=d),a.value===i&&(this.dialog.schema_chooser.selectedIndex=d,s=a));return void 0===s&&o&&(this.dialog.schema_chooser.selectedIndex=o,s=this.dialog.schema_chooser.options[this.dialog.schema_chooser.selectedIndex]),s?(this.schema=doctored.schemas.get_schema_instance(this,s.getAttribute("data-schema-family"),s.value),e(this.schema.init,this.schema)(this,s.value,!1),void e(this.lint_soon,this)()):doctored.util.alert("Doctored.js can't find a valid default schema.")},schema_chooser_change:function(t){var e=!!doctored.util.confirm("Do you want a new document for that schema?\n(WARNING: current document will be lost!)"),i=this.dialog.schema_chooser.options[this.dialog.schema_chooser.selectedIndex],s=doctored.util.this_function;return i?(this.schema=doctored.schemas.get_schema_instance(this,i.getAttribute("data-schema-family"),i.value),s(this.schema.init,this.schema)(this,i.value,e),this.manifest[doctored.util.get_tab_index(this.tabs.current_tab)].schema=i.value,this.dialog.style.display="none",void this.root.focus()):doctored.util.alert("No schema chosen")},paste:function(t){var e=doctored.util.get_clipboard_xml_as_html_string(t.clipboardData),i=doctored.util.this_function,s;return this.schema.convert_from_html&&doctored.util.looks_like_html(e)?(t.returnValue=!1,void setTimeout(function(){doctored.util.confirm("That looks like HTML - want to convert it to "+this.schema.name+"?")&&(e=this.schema.convert_from_html(e)),s=doctored.util.convert_html_to_doctored_html(e),doctored.util.insert_html_at_cursor_position(s,t)},0)):(s=doctored.util.convert_xml_to_doctored_html(e),doctored.util.insert_html_at_cursor_position(s,t),void i(this.lint_soon,this)())},element_chooser_change:function(t){var e,i,s,o;if(this.cache.just_hit_esc)return void(this.cache.just_hit_esc=!1);if(e=this.dialog.element_chooser,i=e.options[e.selectedIndex],s=i.innerText||i.textContent,o=i.getAttribute("value"))switch(this.dialog.mode){case"createElement":doctored.util.this_function(this.update_element,this)(t),this.dialog.style.display="none",delete this.dialog.target;break;case"editElement":doctored.util.this_function(this.update_element,this)(t),this.schema.set_dialog_context(this.dialog,void 0,s);break;default:doctored.util.alert("Unrecognised dialog mode "+this.dialog.mode)}},update_element:function(t){var e=this.dialog,i=e.element_chooser,s=i.options[i.selectedIndex],o=s.getAttribute("value"),a=s.innerText||s.textContent,d="block",r=doctored.util.this_function;if(!o||0===o.length)return doctored.util.remove_old_selection(e.target,e);if(!e.target)return"Trying to update element when there is no target?";if(!e.target.classList.contains("doctored")){switch(o){case"inline":case"block":d=o}e.target.className=doctored.CONSTANTS.block_or_inline_class_prefix+d}return o!==doctored.CONSTANTS.custom_element_value||(a=doctored.util.prompt("Custom element:"))?(e.target.setAttribute("data-element",a),void r(this.lint_soon,this)()):doctored.util.remove_old_selection(e.target,e)},properties:function(t){doctored.util.display_element_dialog(this.root,this.dialog,void 0,doctored.CONSTANTS.root_context,this.schema),t.preventDefault()},hamburger_button_click:function(t){var e=this.hamburger_button.getBoundingClientRect();this.hamburger_menu.style.display="block",this.hamburger_menu.style.left=e.left-this.hamburger_menu.offsetWidth+"px",this.hamburger_menu.style.top=e.top+"px",t.preventDefault()},hamburger_change_theme:function(t){var e=this.hamburger_menu.theme_chooser,i=e.options[e.selectedIndex],s=i.textContent;window.localStorage.setItem("doctored-theme",s),doctored.util.set_theme(s,this),this.hamburger_menu.style.display="none",e.selectedIndex=0,t.preventDefault()},hamburger_close:function(t){this.hamburger_menu.style.display="none",t.preventDefault()},close_dialog:function(t){this.dialog.style.display="none",doctored.util.remove_old_selection(this.dialog.target,this),t.preventDefault()},reset_theme:function(){delete this.root.default_marginLeft,this.tabs_resize()},view_source:function(t){var e=this.view_source_textarea,i=this.view_source_resizer,s=doctored.util.this_function,o,a,d;this.root.default_marginLeft||(i.style.display="block",d=i.getBoundingClientRect(),i.style.height="500px",i.padding_added_to_height=i.offsetHeight-500,i.outer_width=d.width,e.style.width="500px",e.style.height="500px",e.style.display="block",e.padding_added_to_width=e.offsetWidth-500,e.padding_added_to_height=e.offsetHeight-500,this.root.parent_boundaries=this.root.parentNode.getBoundingClientRect(),this.root.style.marginLeft="",a=this.root.getBoundingClientRect(),this.root.default_marginLeft=parseInt(window.getComputedStyle(this.root)["margin-left"],10),e.maximum_width=this.root.offsetWidth-doctored.CONSTANTS.error_gutter_width_pixels-doctored.CONSTANTS.text_area_resizer_maximum_pixels-i.outer_width,e.width=(a.width-i.outer_width)/2-e.padding_added_to_width,e.style.width=e.width+"px"),this.menu.view_source.classList.toggle(doctored.CONSTANTS.menu_option_on),o=this.menu.view_source.classList.contains(doctored.CONSTANTS.menu_option_on),o?(e.style.display="block",i.style.display="block",e.value=this.get_xml_string(),e.focus(),s(this.view_source_resize,this)()):(e.style.display="none",i.style.display="none",this.root.style.marginLeft=this.root.default_marginLeft+"px"),t.preventDefault()},view_source_change:function(t){this.set_xml_string(this.view_source_textarea.value)},view_source_resizer_drag_start:function(t){var e,i=this.view_source_textarea,s=this.view_source_resizer;t.which===doctored.CONSTANTS.left_mouse_button&&(e=this.root.getBoundingClientRect(),s.dragging=!0,s.drag_offset=t.layerX)},tabs_drag_start:function(t){t.which===doctored.CONSTANTS.left_mouse_button&&(this.tabs.dragging=!0,this.tabs.dragging_tab=doctored.util.get_closest_by_nodeName(t.target,"li"),this.tabs.dragging_tab_index=doctored.util.get_tab_index(this.tabs.dragging_tab),this.tabs.dragging_started=!1,this.tabs.dragging_start_offset={x:t.layerX},this.tabs.dragging_start_mouse_position={x:t.x||t.clientX},void 0===this.tabs.drop_target&&(this.tabs.drop_target=document.createElement("li"),this.tabs.drop_target.className="doctored-drop-target",this.tabs.appendChild(this.tabs.drop_target),this.tabs.drop_target_padding_border=this.tabs.drop_target.offsetWidth-parseInt(window.getComputedStyle(this.tabs.drop_target).width,10),this.tabs.removeChild(this.tabs.drop_target)),this.tabs.tab_offsetWidth=this.tabs.dragging_tab.offsetWidth,this.tabs.drop_target.style.width=this.tabs.tab_offsetWidth-this.tabs.drop_target_padding_border+"px",this.tabs.drop_target.style.height=this.tabs.dragging_tab.offsetHeight-5+"px",this.tabs.left=this.tabs.getBoundingClientRect().left,this.tabs.child_nodes_at_drag_start_time=Array.prototype.slice.call(this.tabs.childNodes),this.tabs.dragging_mouse_start_position={x:t.x||t.clientX})},drag:function(t){var e=doctored.util.this_function;return this.view_source_resizer.dragging===!0?e(this.drag_view_source,this)(t):this.tabs.dragging===!0?e(this.drag_tabs,this)(t):void 0},drag_tabs:function(t){var e={x:t.x||t.clientX};this.tabs.dragging_started===!1&&(e.x<this.tabs.dragging_mouse_start_position.x-doctored.CONSTANTS.drag_distance_activates_pixels||e.x>this.tabs.dragging_mouse_start_position.x+doctored.CONSTANTS.drag_distance_activates_pixels)&&(this.tabs.dragging_started=!0,this.tabs.dragging_tab.classList.add("doctored-dragging-tab"),this.tabs.insertBefore(this.tabs.drop_target,this.tabs.dragging_tab.nextSibling)),this.tabs.dragging_started===!0&&(this.tabs.dragging_tab.style.left=e.x-this.tabs.dragging_start_offset.x+"px",this.tabs.drop_target_index=Math.floor((e.x-this.tabs.left)/this.tabs.tab_offsetWidth),this.tabs.drop_target_index>=this.tabs.child_nodes_at_drag_start_time.length-1?this.tabs.drop_target_index=this.tabs.child_nodes_at_drag_start_time.length-2:this.tabs.drop_target_index<0&&(this.tabs.drop_target_index=0),e.x>this.tabs.dragging_start_mouse_position.x&&(this.tabs.drop_target_index+=1),this.tabs.insertBefore(this.tabs.drop_target,this.tabs.child_nodes_at_drag_start_time[this.tabs.drop_target_index])),t.preventDefault()},drag_view_source:function(t){var e=doctored.util.this_function,i=this.view_source_textarea,s=this.view_source_resizer;this.view_source_resizer.dragging!==!1&&(i.width=(t.x||t.clientX)-this.root.parent_boundaries.left-this.root.default_marginLeft-i.padding_added_to_width-this.view_source_resizer.drag_offset,i.width<doctored.CONSTANTS.text_area_resizer_minimum_pixels-this.root.default_marginLeft?i.width=doctored.CONSTANTS.text_area_resizer_minimum_pixels-this.root.default_marginLeft:i.width>i.maximum_width&&(i.width=i.maximum_width),e(this.view_source_resize,this)(),t.preventDefault())},drag_end:function(t){var e=doctored.util.this_function,i;t.preventDefault(),this.tabs.dragging===!0?(this.tabs.dragging=!1,this.tabs.dragging_started?(this.tabs.dragging_tab.style.left="0px",this.tabs.dragging_tab.classList.remove("doctored-dragging-tab"),this.tabs.drop_target.parentNode&&this.tabs.drop_target.parentNode==this.tabs&&(this.tabs.removeChild(this.tabs.drop_target),i=doctored.util.get_tab_index(this.tabs.dragging_tab),this.tabs.insertBefore(this.tabs.dragging_tab,this.tabs.child_nodes_at_drag_start_time[this.tabs.drop_target_index]),i<this.tabs.drop_target_index&&(this.tabs.drop_target_index-=1),this.manifest.splice(this.tabs.drop_target_index,0,this.manifest.splice(i,1)[0]))):e(this.tabs_click,this)(t)):this.view_source_resizer.dragging===!0&&(this.view_source_resizer.dragging=!1)},view_source_resize:function(){var t=this.view_source_textarea,e=this.view_source_resizer,i;this.root.style.marginLeft=this.root.default_marginLeft+t.width+t.padding_added_to_width+e.outer_width+"px",i=this.root.getBoundingClientRect(),t.style.top=document.body.scrollTop+i.top+"px",t.style.height=i.height-t.padding_added_to_height+"px",t.style.width=t.width+"px",t.style.display="block",t.style.marginLeft=this.root.default_marginLeft+"px",e.style.top=document.body.scrollTop+i.top+"px",e.style.height=i.height-e.padding_added_to_height+"px",e.style.left=this.root.parent_boundaries.left+this.root.default_marginLeft+t.width+t.padding_added_to_width+"px"},keyup_contentEditable_sync_view_source:function(t){var e=this.view_source_textarea;e&&(e.value=this.get_xml_string())},download:function(t){var e=this.get_xml_string(),i=this.root_selector.replace(/[#-]/g,"").replace(/\s/g,"")+e.replace(/<[^>]*?>/g,"").replace(/\s/g,"");i.length>10?i=i.substr(0,10):i.length<4&&(i="download"),i+=".xml",t.preventDefault(),doctored.util.offer_download(e,i)},keyup_dialog_esc:function(t){var e=doctored.CONSTANTS.key.esc;t.keyCode==e&&(doctored.util.remove_old_selection(this.dialog.target,this),this.dialog.style.display="none",this.cache.just_hit_esc=!0)},keyup_dialog_attributes_enter:function(t){var e=doctored.CONSTANTS.key.enter,i,s;t.keyCode==e&&(i=doctored.util.gather_attributes(this.dialog.attributes_div.childNodes),this.dialog.target.setAttribute("data-attributes",doctored.util.encode_data_attributes(i)),this.dialog.style.display="none",delete this.dialog.target)},keyup_contentEditable:function(t){var i=doctored.CONSTANTS.key.esc,s=doctored.CONSTANTS.key.enter,o,a;if(t.keyCode===i)o=doctored.util.get_current_selection(),a=o.getRangeAt(0).endContainer.parentNode,doctored.util.display_element_dialog(a,this.dialog,void 0,a.getAttribute("data-element"),this.schema),this.dialog.element_chooser.focus();else if(t.keyCode!==s||t.shiftKey)t.shiftKey===!1&&doctored.util.this_function(this.click,this)(t);else{if(doctored.util.is_webkit)return;doctored.util.process_linebreaks(e("br",this.root)),t.preventDefault()}},click:function(t){var i=doctored.util.get_current_selection(),s=t.toElement||t.target,o=t.x||t.clientX?{x:t.x||t.clientX,y:t.y||t.clientY}:void 0,a=doctored.util.within_pseudoelement(s,o),d=doctored.util.within_delete_elemente(s,o),r,n;if(s.classList.contains("doctored-block")){var l=e(".selected"),h=e(".selected-style"),c=0,_=0;for(c;c<l.length;c++)l.item(c).classList.remove("selected");for(_;_<h.length;_++)h.item(_).classList.remove("selected-style");s.classList.add("selected");var u=s.getAttribute("data-element"),g=e(".style[data-element="+u+"]").item(0);g&&g.classList.add("selected-style")}this.dialog.style.display="none",doctored.util.remove_old_selection(this.dialog.target,this.dialog),i.rangeCount&&(r=doctored.util.surround_selection_with_element("div","doctored-selection",this,i,o),r&&r.parentNode?doctored.util.display_dialog_around_inline(r,this.dialog,o,this.schema):a===doctored.CONSTANTS.edit_element_css_cursor?doctored.util.display_element_dialog(s,this.dialog,o,s.parentNode.getAttribute("data-element"),this.schema):d&&s.remove())},styleSelect_click:function(t){var i=e(".selected").item(0),s=t.target,o=s.getAttribute("data-element");i.setAttribute("data-element",o);for(var a=e(".selected-style"),d=0;d<a.length;d++)a.item(d).classList.remove("selected-style");s.classList.add("selected-style");var r=e("element",this.schema.documentElement);this.lint_soon()},clone_element_below:function(){var t=this.dialog.target,e=t.cloneNode(!0);e.innerHTML="",t.parentNode.insertBefore(e,t.nextSibling),this.lint_soon()},clone_element_above:function(){var t=this.dialog.target,e=t.cloneNode(!0);e.innerHTML="",t.parentNode.insertBefore(e,t),this.lint_soon()},add_attribute_item:function(){var t=this.dialog.attributes_template.cloneNode(!0);return this.dialog.attributes_add.parentNode.insertBefore(t,this.dialog.attributes_add),t},add_attribute_item_key:function(t){doctored.util.this_function(this.add_attribute_item,this)().childNodes[0].focus()},add_attribute_item_value:function(t){doctored.util.this_function(this.add_attribute_item,this)().childNodes[2].focus()},mousemove:function(t){var e=t.toElement||t.target,i="auto",s;e&&(s=doctored.util.within_pseudoelement(e,{x:t.x||t.clientX,y:t.y||t.clientY}),s!==!1&&(i=s),this.root.style.cursor=i)},show_tooltip:function(t,e,i){var s=this;this.tooltip.innerHTML=t,this.tooltip.style.left=e+"px",this.tooltip.style.top=i+"px",this.tooltip.style.display="block",this.tooltip.classList.remove("doctored-hidden"),this.tooltip.timer&&clearTimeout(this.tooltip.timer),this.tooltip.timer=setTimeout(function(){s.tooltip.classList.add("doctored-hidden")},1e3)},hide_tooltip:function(t){this.tooltip.style.display="none"}},a.init(),doctored.instances=doctored.instances||[],doctored.instances.push(a),a},doctored.CONSTANTS={key:{enter:13,esc:27},current_tab_class:"doctored-current",inline_label_height_in_pixels:10,block_label_width_in_pixels:25,delete_label_width_in_pixels:25,edit_element_css_cursor:"pointer",doctored_container_class:"doctored",custom_element_value:"(custom)",xml_declaration:'<?xml version="1.0"?>',theme_prefix:"doctored-theme-",intentional_linebreak_class:"doctored-linebreak",root_context:"/",block_or_inline_class_prefix:"doctored-",menu_option_on:"doctored-on",error_gutter_width_pixels:200,left_mouse_button:1,text_area_resizer_minimum_pixels:100,text_area_resizer_maximum_pixels:150,minimum_tab_width:4,drag_distance_activates_pixels:25,dialog_supression_wait_milliseconds:5},doctored.CONSTANTS.block_class=doctored.CONSTANTS.block_or_inline_class_prefix+"block",doctored.CONSTANTS.inline_class=doctored.CONSTANTS.block_or_inline_class_prefix+"inline"}();